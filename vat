import streamlit as st
import math

# -----------------------------------------------------------
# 1. [ë¡œì§] ë‚™ì°°ìˆ˜ìˆ˜ë£Œ
# -----------------------------------------------------------
def get_auction_fee(price, route):
    if route == "ì…€í”„":
        if price <= 1000000: return 75000
        elif price <= 5000000: return 185000
        elif price <= 10000000: return 245000
        elif price <= 20000000: return 250000
        elif price <= 30000000: return 250000
        else: return 360000
    elif route == "ì œë¡œ":
        if price <= 1000000: return 140000
        elif price <= 5000000: return 300000
        elif price <= 10000000: return 365000
        elif price <= 15000000: return 365000
        elif price <= 30000000: return 395000
        elif price <= 40000000: return 475000
        else: return 505000
    else: return 0

# -----------------------------------------------------------
# 2. [ë¡œì§] ë§¤ì…ë“±ë¡ë¹„
# -----------------------------------------------------------
def get_reg_cost(bid_price, p_type):
    threshold = 28500001
    rate = 0.0105
    if p_type == "ê°œì¸":
        if bid_price >= threshold: return int(bid_price * rate)
        else: return 0
    else:
        supply_price = bid_price / 1.1
        if supply_price >= threshold: return int(supply_price * rate)
        else: return 0

# -----------------------------------------------------------
# 3. ë©”ì¸ ì•± (V36-VAT: í”„ë¦¬ëœì„œ ì„¸ê¸ˆ 13.3% + ìƒí’ˆí™” ë¶€ê°€ì„¸ 10% ì§€ì¶œ)
# -----------------------------------------------------------
def smart_purchase_calculator_v36_vat():
    st.set_page_config(page_title="ë§¤ì…ê²¬ì ì„œ V36-VAT by ê¹€í¬ì£¼", layout="wide")
    
    st.markdown("""
    <style>
        html, body, [class*="css"] { font-size: 16px; }
        @media (max-width: 600px) { html, body, [class*="css"] { font-size: 14px; } }
        h1 { font-size: clamp(1.5rem, 4vw, 2.5rem) !important; font-weight: 800 !important; }
        .big-price { font-size: clamp(1.6rem, 3.5vw, 2.2rem); font-weight: 900; color: #4dabf7; margin-bottom: 0px; }
        .real-income { font-size: clamp(1.4rem, 2.5vw, 1.8rem); font-weight: bold; }
        .margin-rate { font-size: clamp(2.0rem, 4vw, 2.5rem); font-weight: 900; color: #ff6b6b; }
        .input-check { font-size: 0.9rem; color: #2e7d32; font-weight: bold; margin-top: -10px; margin-bottom: 20px; }
        .section-header { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; border-left: 4px solid #4dabf7; padding-left: 10px; }
        .detail-table-container { width: 100%; max-width: 450px; margin: 0 auto; }
        .detail-table { width: 100%; border-collapse: collapse; font-size: clamp(0.9rem, 2.5vw, 1.1rem); }
        .detail-table td { padding: 6px 10px; border-bottom: 1px solid #555; }
        @media (prefers-color-scheme: light) { .detail-table td { border-bottom: 1px solid #ddd; } }
        .detail-label { font-weight: bold; opacity: 0.9; white-space: nowrap; }
        .detail-value { text-align: right; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

    if 'p_type' not in st.session_state: st.session_state['p_type'] = "ê°œì¸"
    if 'p_route' not in st.session_state: st.session_state['p_route'] = "ì…€í”„"
    if 't_cost' not in st.session_state: st.session_state['t_cost'] = 30000
    if 'check_cost' not in st.session_state: st.session_state['check_cost'] = 66000
    if 'cost_dent' not in st.session_state: st.session_state['cost_dent'] = 0
    if 'cost_wheel' not in st.session_state: st.session_state['cost_wheel'] = 0
    if 'cost_etc' not in st.session_state: st.session_state['cost_etc'] = 0

    def smart_unit_converter(key):
        val = st.session_state[key]
        if 0 < val <= 20000: st.session_state[key] = val * 10000

    st.title("ë§¤ì…ê²¬ì ì„œ V36-VAT by ê¹€í¬ì£¼")

    # Step 1. ìƒë‹¨ ì •ë³´
    col1, col2, col3 = st.columns([1.5, 1, 1])
    with col1:
        sales_input = st.number_input("íŒë§¤ ì˜ˆì •ê°€ (ë‹¨ìœ„: ë§Œì›)", value=3500, step=10, format="%d")
        sales_price = sales_input * 10000
        st.markdown(f"<div class='input-check'>í™•ì¸: {sales_price:,} ì›</div>", unsafe_allow_html=True)
    with col2:
        p_type = st.radio("ë§¤ì…ìœ í˜•", ["ê°œì¸", "ì‚¬ì—…ì"], key='p_type')
    with col3:
        p_route = st.selectbox("ë§¤ì…ë£¨íŠ¸", ["ì…€í”„", "ì œë¡œ", "ê°œì¸ê±°ë˜"], key='p_route')

    st.markdown("---")

    # Step 2. ë©”ì¸ ì…ë ¥
    left_col, right_col = st.columns([1, 1], gap="large")

    with left_col:
        st.markdown("<div class='section-header'>ìƒí’ˆí™” ë¹„ìš© ì…ë ¥ (ì„¸ì „ ì…ë ¥)</div>", unsafe_allow_html=True)
        # ì„ íƒí•œ ê¸ˆì•¡ì— ë¶€ê°€ì„¸ 10% ìë™ ê°€ì‚°
        raw_check = st.radio("ì„±ëŠ¥ì ê²€ë¹„ (VATë³„ë„)", [40000, 60000], key='check_cost_raw', horizontal=True)
        cost_perf = int(raw_check * 1.1)
        
        raw_transport = st.selectbox("êµí†µë¹„ (VATë³„ë„)", [30000, 50000, 80000, 130000, 170000, 200000])
        cost_transport = int(raw_transport * 1.1)
        
        cost_dent_raw = st.number_input("íŒê¸ˆ/ë„ìƒ‰ (ë³„ë„)", step=10000, format="%d", key='cost_dent', on_change=smart_unit_converter, args=('cost_dent',))
        cost_wheel_raw = st.number_input("íœ /íƒ€ì´ì–´ (ë³„ë„)", step=10000, format="%d", key='cost_wheel', on_change=smart_unit_converter, args=('cost_wheel',))
        cost_etc_raw = st.number_input("ê¸°íƒ€ë¹„ìš© (ë³„ë„)", step=10000, format="%d", key='cost_etc', on_change=smart_unit_converter, args=('cost_etc',))

        # ë‚´ë¶€ ê³„ì‚°ìš© ë¶€ê°€ì„¸ í•©ì‚°
        cost_repair_vat = int((cost_dent_raw + cost_wheel_raw + cost_etc_raw) * 1.1)
        HIDDEN_AD = int(250000 * 1.1)
        HIDDEN_POLISH = int(120000 * 1.1)
        HIDDEN_DEPOSIT = 60000 # ì…ê¸ˆë¹„ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€

        total_fixed_vat = cost_perf + cost_transport + cost_repair_vat + HIDDEN_AD + HIDDEN_POLISH + HIDDEN_DEPOSIT
        st.caption(f"â€» ê´‘ê³ , ê´‘íƒ ë“± ëª¨ë“  í•­ëª© ë¶€ê°€ì„¸ 10% í¬í•¨ ì§€ì¶œë¡œ ê³„ì‚°ë¨")

    # ê°€ì´ë“œ ê³„ì‚° (V36 ê¸°ì¤€ 5.5% ë§ˆì§„)
    budget_after_55 = int(sales_price * 0.945)
    guide_bid = 0
    start_point = budget_after_55 - total_fixed_vat
    for bid in range(start_point, start_point - 5000000, -10000):
        fee = get_auction_fee(bid, p_route)
        reg = get_reg_cost(bid, p_type)
        interest = int(bid * 0.01) # V36 ê¸ˆë¦¬ 1% ìœ ì§€
        if (bid + total_fixed_vat + fee + reg + interest) <= budget_after_margin: # V36 ë¡œì§
            pass # ì•„ë˜ ë¡œì§ìœ¼ë¡œ ëŒ€ì²´
    
    # ê°€ì´ë“œ ê³„ì‚° ë³´ì • (V36 ì˜¤ë¦¬ì§€ë„ ë¡œì§ì— ë¶€ê°€ì„¸ ì§€ì¶œë§Œ ë°˜ì˜)
    for bid in range(start_point, start_point - 5000000, -10000):
        fee = get_auction_fee(bid, p_route)
        reg = get_reg_cost(bid, p_type)
        if (bid + total_fixed_vat + fee + reg) <= budget_after_55:
            guide_bid = bid
            break
    if guide_bid > 0: guide_bid = math.ceil(guide_bid / 10000) * 10000

    if 'prev_guide_bid' not in st.session_state: st.session_state['prev_guide_bid'] = -1
    if guide_bid != st.session_state['prev_guide_bid']:
        st.session_state['my_bid_input'] = guide_bid
        st.session_state['prev_guide_bid'] = guide_bid

    with right_col:
        st.markdown("<div class='section-header'>ì…ì°° ê¸ˆì•¡ ê²°ì •</div>", unsafe_allow_html=True)
        st.markdown("**ì ì • ë§¤ì…ê°€ (Guide)**")
        st.markdown(f"<div class='big-price'>{guide_bid:,} ì›</div>", unsafe_allow_html=True)
        st.write("")
        my_bid = st.number_input("ì…ì°°ê°€ ì…ë ¥", step=10000, format="%d", label_visibility="collapsed", key='my_bid_input', on_change=smart_unit_converter, args=('my_bid_input',))

    st.markdown("---")

    # Step 3. V36 ì„¸ê¸ˆ ë¡œì§ (13.3% ì°¨ê°)
    real_fee = get_auction_fee(my_bid, p_route)
    real_reg = get_reg_cost(my_bid, p_type)
    real_interest = int(my_bid * 0.01)
    
    # ë”œëŸ¬ ìˆ˜ìµ ë¶€ê°€ì„¸ 10% ì°¨ê° ë¡œì§
    gross_margin = sales_price - my_bid - (cost_perf + HIDDEN_AD + real_fee)
    dealer_income = int(gross_margin / 1.1)
    
    # í”„ë¦¬ëœì„œ ì›ì²œì„¸ 3.3% ì°¨ê° ë¡œì§
    tax_base = dealer_income - real_reg
    tax_33 = int(tax_base * 0.033) if tax_base > 0 else 0
    
    # ì‹¤ì†Œë“ ê³„ì‚° (ìƒí’ˆí™” ë¹„ìš©ì— ë¶€ê°€ì„¸ê°€ ë‹¤ í¬í•¨ëœ ìƒíƒœë¡œ ì°¨ê°)
    real_income = dealer_income - (cost_transport + cost_repair_vat + HIDDEN_POLISH + HIDDEN_DEPOSIT + real_reg + real_interest + tax_33)
    real_margin_rate = (real_income / my_bid) * 100 if my_bid > 0 else 0
    total_cost = my_bid + total_fixed_vat + real_reg + real_interest

    c_final1, c_final2 = st.columns(2)
    with c_final1:
        st.markdown("<div style='text-align:center;'>ì˜ˆìƒ ì‹¤ì†Œë“ì•¡ (ì„¸í›„)</div>", unsafe_allow_html=True)
        st.markdown(f"<div style='text-align:center;' class='real-income'>{real_income:,} ì›</div>", unsafe_allow_html=True)
    with c_final2:
        st.markdown("<div style='text-align:center;'>ì˜ˆìƒ ì´ìµë¥  (ë§¤ì…ê°€ ëŒ€ë¹„)</div>", unsafe_allow_html=True)
        st.markdown(f"<div style='text-align:center;' class='margin-rate'>{real_margin_rate:.2f} %</div>", unsafe_allow_html=True)

    with st.expander("ğŸ§¾ ìƒì„¸ ê²¬ì  ë° ë³µì‚¬"):
        st.code(f"íŒë§¤ê°€: {sales_price:,}ì›\në§¤ì…ê°€: {my_bid:,}ì›\nì‹¤ì†Œë“: {real_income:,}ì›\nì´ìµë¥ : {real_margin_rate:.2f}%", language="text")

if __name__ == "__main__":
    smart_purchase_calculator_v36_vat()
